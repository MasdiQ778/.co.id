<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Billing PS</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <header>
      <h2>Dashboard Billing PS</h2>
      <div class="top-right">
        <button onclick="toggleTheme()">ðŸŒ— Tema</button>
        <button onclick="logout()" class="logout">Logout</button>
      </div>
    </header>

    <section class="billing-input">
      <input type="number" id="durationInput" placeholder="Durasi (menit)" />
      <button onclick="startBilling()">Mulai</button>
      <button onclick="exportExcel()">Export Excel</button>
    </section>

    <section>
      <h3>Billing Aktif</h3>
      <div id="activeBillingContainer"></div>
    </section>

    <section>
      <h3>Riwayat Billing Hari Ini</h3>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Durasi</th>
            <th>Total Harga</th>
            <th>Waktu Selesai</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script>
    const pricePerHour = 5000;
    const historyTable = document.getElementById("historyTable").querySelector("tbody");

    function toggleTheme() {
      const html = document.documentElement;
      html.setAttribute("data-theme", html.getAttribute("data-theme") === "dark" ? "light" : "dark");
    }

    function logout() {
      localStorage.removeItem("adminLoggedIn");
      window.location.href = "index.html";
    }

    function startBilling() {
      const duration = parseInt(document.getElementById("durationInput").value);
      if (!duration || duration <= 0) return alert("Masukkan durasi (menit) dengan benar.");

      const ms = duration * 60 * 1000;
      const harga = (duration / 60) * pricePerHour;
      const id = Date.now();
      const bubble = document.createElement("div");
      bubble.className = "billing-card";
      bubble.setAttribute("data-id", id);
      bubble.innerHTML = `
        <div>
          <strong>${duration} menit</strong><br>
          <span id="timer-${id}">Menghitung...</span><br>
          <span class="price">Rp ${harga.toLocaleString()}</span>
        </div>
        <button onclick="selesaiBilling(${id}, ${duration}, ${harga})">Selesai</button>
      `;
      document.getElementById("activeBillingContainer").appendChild(bubble);

      const end = Date.now() + ms;
      const interval = setInterval(() => {
        const now = Date.now();
        const remaining = end - now;
        const min = Math.floor((remaining / 1000 / 60) % 60);
        const sec = Math.floor((remaining / 1000) % 60);
        const timerEl = document.getElementById(`timer-${id}`);
        if (remaining <= 0) {
          clearInterval(interval);
          selesaiBilling(id, duration, harga);
        } else {
          timerEl.textContent = `${min}m ${sec}s`;
        }
      }, 1000);
    }

    function selesaiBilling(id, durasi, harga) {
      const el = document.querySelector(`.billing-card[data-id="${id}"]`);
      if (el) el.remove();
      const now = new Date().toLocaleTimeString();
      const row = historyTable.insertRow();
      row.innerHTML = `
        <td>${durasi} menit</td>
        <td>Rp ${harga.toLocaleString()}</td>
        <td>${now}</td>
      `;
      simpanRiwayat();
    }

    function simpanRiwayat() {
      const data = [];
      historyTable.querySelectorAll("tr").forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length === 3) {
          data.push({
            durasi: cells[0].textContent,
            harga: cells[1].textContent,
            waktu: cells[2].textContent
          });
        }
      });
      localStorage.setItem("riwayatBilling", JSON.stringify(data));
    }

    function loadRiwayat() {
      const data = JSON.parse(localStorage.getItem("riwayatBilling") || "[]");
      data.forEach(item => {
        const row = historyTable.insertRow();
        row.innerHTML = `
          <td>${item.durasi}</td>
          <td>${item.harga}</td>
          <td>${item.waktu}</td>
        `;
      });
    }

    function exportExcel() {
      const table = document.getElementById("historyTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Riwayat Billing" });
      XLSX.writeFile(wb, "riwayat_billing.xlsx");
    }

    loadRiwayat();
  </script>
</body>
</html>
