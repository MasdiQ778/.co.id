<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Billing PS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #f4f4f4;
      --card: white;
      --text: #333;
      --accent: #127F99;
    }
    [data-theme="dark"] {
      --bg: #1e1e1e;
      --card: #2c2c2c;
      --text: #eee;
      --accent: #0aa3c2;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
      padding: 1rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .bubble {
      background-color: var(--card);
      border-left: 8px solid var(--accent);
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    input, button {
      padding: 0.7rem;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
    }

    .timer {
      font-size: 1.4rem;
      font-weight: bold;
    }

    .history {
      margin-top: 2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logout {
      background: crimson;
    }
  </style>
</head>
<body>

<header>
  <h2>Billing PS - Dashboard</h2>
  <div class="top-controls">
    <button onclick="toggleTheme()">ðŸŒ“ Dark Mode</button>
    <button onclick="logout()" class="logout">Logout</button>
  </div>
</header>

<div>
  <input type="text" id="nama" placeholder="Nama Pengguna">
  <input type="number" id="durasi" placeholder="Durasi (menit)">
  <button onclick="mulaiBilling()">Mulai Billing</button>
</div>

<div id="billingAktif"></div>

<div class="history">
  <h3>Riwayat Billing</h3>
  <button onclick="exportExcel()">ðŸ“„ Export Excel</button>
  <table id="riwayatTable">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Durasi</th>
        <th>Total (Rp)</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const hargaPerJam = 5000;

  function toggleTheme() {
    const current = document.documentElement.getAttribute("data-theme");
    document.documentElement.setAttribute("data-theme", current === "dark" ? "light" : "dark");
  }

  function logout() {
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("adminUser");
    window.location.href = "login.html";
  }

  function mulaiBilling() {
    const nama = document.getElementById('nama').value.trim();
    const durasi = parseInt(document.getElementById('durasi').value);
    if (!nama || isNaN(durasi) || durasi <= 0) {
      alert("Masukkan nama dan durasi dengan benar.");
      return;
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const totalHarga = Math.round((durasi / 60) * hargaPerJam);
    const selesaiWaktu = Date.now() + durasi * 60000;

    const timerEl = document.createElement("div");
    timerEl.className = "timer";

    const stopBtn = document.createElement("button");
    stopBtn.textContent = "Selesai";
    stopBtn.onclick = function () {
      const waktuSelesai = new Date().toLocaleString();
      simpanRiwayat(nama, durasi, totalHarga, waktuSelesai);
      bubble.remove();
    };

    bubble.innerHTML = `<strong>${nama}</strong> - ${durasi} menit<br>Total: Rp ${totalHarga.toLocaleString()}<br>`;
    bubble.appendChild(timerEl);
    bubble.appendChild(stopBtn);
    document.getElementById("billingAktif").appendChild(bubble);

    updateTimer();

    function updateTimer() {
      const now = Date.now();
      const sisa = Math.max(0, selesaiWaktu - now);
      const menit = Math.floor(sisa / 60000);
      const detik = Math.floor((sisa % 60000) / 1000);
      timerEl.textContent = `${menit}m ${detik}s`;

      if (sisa > 0) {
        requestAnimationFrame(updateTimer);
      } else {
        timerEl.textContent = "Waktu Habis";
      }
    }

    document.getElementById("nama").value = "";
    document.getElementById("durasi").value = "";
  }

  function simpanRiwayat(nama, durasi, total, waktu) {
    const data = JSON.parse(localStorage.getItem("riwayatBilling") || "[]");
    data.push({ nama, durasi, total, waktu });
    localStorage.setItem("riwayatBilling", JSON.stringify(data));
    tampilkanRiwayat();
  }

  function tampilkanRiwayat() {
    const tbody = document.querySelector("#riwayatTable tbody");
    tbody.innerHTML = "";
    const data = JSON.parse(localStorage.getItem("riwayatBilling") || "[]");
    for (const d of data) {
      const row = `<tr>
        <td>${d.nama}</td>
        <td>${d.durasi} menit</td>
        <td>Rp ${d.total.toLocaleString()}</td>
        <td>${d.waktu}</td>
      </tr>`;
      tbody.innerHTML += row;
    }
  }

  function exportExcel() {
    const data = JSON.parse(localStorage.getItem("riwayatBilling") || "[]");
    if (data.length === 0) return alert("Tidak ada data untuk diexport.");

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Riwayat Billing");
    XLSX.writeFile(wb, "riwayat_billing.xlsx");
  }

  // Cek login
  if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "login.html";
  }

  tampilkanRiwayat();
</script>
</body>
</html>
