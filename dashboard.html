<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Billing PS</title>
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="left">
        <h2>Billing Aktif</h2>
      </div>
      <div class="right">
        <a href="#" class="dark-toggle" onclick="toggleTheme()">ðŸŒ— Tema</a>
        <a href="#" class="logout" onclick="logout()">Logout</a>
      </div>
    </header>

    <div class="controls">
      <input type="number" id="durationInput" placeholder="Durasi (menit)" />
      <button onclick="startBilling()">Mulai</button>
      <button onclick="exportExcel()">Export Excel</button>
    </div>

    <div id="activeBillingContainer"></div>

    <h3>Riwayat Billing Hari Ini</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Durasi (menit)</th>
          <th>Total Harga</th>
          <th>Waktu Selesai</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const activeBillingContainer = document.getElementById("activeBillingContainer");
    const historyTable = document.getElementById("historyTable").querySelector("tbody");
    const pricePerHour = 5000;

    function toggleTheme() {
      const html = document.documentElement;
      html.setAttribute("data-theme", html.getAttribute("data-theme") === "dark" ? "light" : "dark");
    }

    function logout() {
      localStorage.removeItem("adminLoggedIn");
      window.location.href = "index.html";
    }

    function startBilling() {
      const minutes = parseInt(document.getElementById("durationInput").value);
      if (isNaN(minutes) || minutes <= 0) {
        alert("Masukkan durasi dalam menit!");
        return;
      }

      const ms = minutes * 60 * 1000;
      const harga = (minutes / 60) * pricePerHour;
      const id = Date.now();

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.setAttribute("data-id", id);
      bubble.innerHTML = `
        <div>
          <h3>Durasi: <span>${minutes} menit</span></h3>
          <p>Sisa Waktu: <span id="timer-${id}"></span></p>
          <p class="total-box">Rp ${harga.toLocaleString()}</p>
        </div>
        <button class="btn-danger" onclick="selesaiBilling(${id}, ${minutes}, ${harga})">Selesai</button>
      `;
      activeBillingContainer.appendChild(bubble);

      const endTime = Date.now() + ms;
      const interval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        const min = Math.floor((remaining / 1000 / 60) % 60);
        const sec = Math.floor((remaining / 1000) % 60);
        const timerEl = document.getElementById(`timer-${id}`);
        if (timerEl) {
          timerEl.textContent = `${min}m ${sec}s`;
        }
        if (remaining <= 0) {
          clearInterval(interval);
          selesaiBilling(id, minutes, harga);
        }
      }, 1000);
    }

    function selesaiBilling(id, durasi, harga) {
      const bubble = document.querySelector(`.bubble[data-id="${id}"]`);
      if (bubble) bubble.remove();

      const now = new Date().toLocaleTimeString();
      const row = historyTable.insertRow();
      row.insertCell(0).textContent = `${durasi} menit`;
      row.insertCell(1).textContent = `Rp ${harga.toLocaleString()}`;
      row.insertCell(2).textContent = now;

      simpanRiwayat();
    }

    function simpanRiwayat() {
      const data = [];
      const rows = historyTable.querySelectorAll("tr");
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td");
        if (cells.length === 3) {
          data.push({
            durasi: cells[0].textContent,
            harga: cells[1].textContent,
            selesai: cells[2].textContent,
          });
        }
      });
      localStorage.setItem("riwayatBilling", JSON.stringify(data));
    }

    function loadRiwayat() {
      const data = JSON.parse(localStorage.getItem("riwayatBilling")) || [];
      data.forEach((item) => {
        const row = historyTable.insertRow();
        row.insertCell(0).textContent = item.durasi;
        row.insertCell(1).textContent = item.harga;
        row.insertCell(2).textContent = item.selesai;
      });
    }

    function exportExcel() {
      const table = document.getElementById("historyTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Riwayat Billing" });
      XLSX.writeFile(wb, "riwayat_billing.xlsx");
    }

    // Auto-load
    loadRiwayat();
  </script>
</body>
</html>
